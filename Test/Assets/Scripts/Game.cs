//------------------------------------------------------------------------------
// <auto-generated>
//     이 코드는 도구를 사용하여 생성되었습니다.
//     런타임 버전:4.0.30319.18444
//
//     파일 내용을 변경하면 잘못된 동작이 발생할 수 있으며, 코드를 다시 생성하면
//     이러한 변경 내용이 손실됩니다.
// </auto-generated>
//------------------------------------------------------------------------------
using UnityEngine;
using System;
using System.Collections;
using System.Threading;
using System.Collections.Generic;
using Newtonsoft.Json;
using Const;

using S2C = Packet.S2C;
using C2S = Packet.C2S;

using ProtoBuf.Meta;
using FocusManager;


public class Game : MonoBehaviour
{
    private static Game instance;

	public static Game Inst
	{
		get
		{
			if (instance == null) {
				instance = new Game ();
			}
			return instance;
		}
	}

    public static bool IsInitialized() { return instance != null; }

	public bool IsMapLoaded() { return map != null; }

	public GameObject netManagerObject;
	public Vector3 spawnPosition;
	public GameObject playerPrefab;
    public ProjectileSet projectileSet;
    public MapData mapData;
    public GameMenu gameMenu;

    public Map map;
	NetworkManager netManager;
	MapLoader mapLoader;


    TeamSelector teamSelector;

    

    private int ID = -1;

    public int GetID()
    {
        return ID;
    }

    public KeyFocusManager keyFocusManager;
    public MouseFocusManager mouseFocusManager;
    
    public Vector2 RevivalLocation;

    bool isQuitting = false;

    void Init()
    {
        instance = this;
        RevivalLocation = new Vector2(0f, 3f);
        keyFocusManager = new KeyFocusManager(InputKeyFocus.PLAYER);
        mouseFocusManager = new MouseFocusManager(InputMouseFocus.PLAYER);
        keyFocusManager.FreeFocus();
        mouseFocusManager.FreeFocus();

        RuntimeTypeModel.Default.Add(typeof(Vector3), true);
        RuntimeTypeModel.Default.Add(typeof(Vector2), true);
    }

	void Awake()
	{
        Init();
		netManager = netManagerObject.GetComponent<NetworkManager> ();
		mapLoader = GetComponent<MapLoader> ();
        teamSelector = GetComponent<TeamSelector>();

	}

	public void LoadMap()
	{
        GameObject mapPrefab = mapLoader.GetMap();

        GameObject mapObj = (GameObject)Network.Instantiate(mapPrefab, Vector3.zero, Quaternion.identity, 0);
	}

    public void SetMap(Map map)
    {
        this.map = map;
    }

	public void StartServerGame()
	{
		ClearGame ();

		if (!IsMapLoaded())
		{
			LoadMap();
		}

        SetMyID(PlayerManager.Inst.SetID(PlayerManager.Inst.GetUniqueID(), Network.player));

        OpenGameMenu();
	}

	void OnPlayerConnected(NetworkPlayer player)
	{
        if (PlayerManager.Inst.Exists(player))
        {
            //Clear previous connection;
            return;
        }

        int ID = PlayerManager.Inst.SetID(PlayerManager.Inst.GetUniqueID(), player);
        networkView.RPC("SetPlayerID", player, ID);
	}
    
    [RPC]
    void SetPlayerID(int newID, NetworkMessageInfo info)
    {
        if (!Network.isClient)
        { 
            return;
        }
     
        SetMyID(newID);

        networkView.RPC("PlayerListRequest", RPCMode.Server, ID);
        
        OpenGameMenu();
    }

    void SetMyID(int newID)
    {
        ID = newID;
    }

    void OpenGameMenu()
    {
        gameMenu.gameObject.SetActive(true);
    }

    public void SelectTeam(Team team)
    {
        C2S.UpdatePlayerTeam selectTeam = new C2S.UpdatePlayerTeam(ID, team);
        networkView.RPC("ServerSelectTeam", RPCMode.Server, selectTeam.SerializeToBytes());
    }

    [RPC]
    void ServerSelectTeam(byte[] updateData, NetworkMessageInfo info)
    {
        if (!Network.isServer) return;

        C2S.UpdatePlayerTeam update = C2S.UpdatePlayerTeam.DeserializeFromBytes(updateData);
        if (!PlayerManager.Inst.IsValidPlayer(update.playerID, info.sender)) return;

        //TODO::TeamSelect Validation (team balance)

        OnSelectTeam(update);
        networkView.RPC("SetPlayerTeam", RPCMode.Others, updateData);

        ReadyToEnterCharacter(PlayerManager.Inst.GetSetting(update.playerID));
    }

    [RPC]
    void SetPlayerTeam(byte[] updateData, NetworkMessageInfo info)
    {
        if (!Network.isClient) return;
        //ServerCheck

        C2S.UpdatePlayerTeam update = C2S.UpdatePlayerTeam.DeserializeFromBytes(updateData);

        OnSelectTeam(update);
    }

    void OnSelectTeam(C2S.UpdatePlayerTeam update)
    {
        PlayerManager.Inst.UpdatePlayer(update);
    }

    public void ServerSpecificSelectTeam(Team team)
    {
        C2S.UpdatePlayerTeam update = new C2S.UpdatePlayerTeam(ID, team);

        OnSelectTeam(update);
        networkView.RPC("SetPlayerTeam", RPCMode.Others, update.SerializeToBytes());

        PlayerSetting setting = PlayerManager.Inst.GetSetting(update.playerID);

        PlayerSettingError error = setting.IsSettingCompleted();
        if (error == PlayerSettingError.NONE)
        {
            EnterCharacter(setting);
            return;
        }

        S2C.PlayerNotReady notReady = new S2C.PlayerNotReady(error);

        switch (notReady.error)
        {
            case PlayerSettingError.NAME:
                OpenGameMenu();
                break;

            case PlayerSettingError.TEAM:
                teamSelector.Open();
                break;
        }
    }

    [RPC]
    public void ServerSetPlayerName(byte[] updateData, NetworkMessageInfo info)
    {
        if (!Network.isServer) return;

        C2S.UpdatePlayerName update = C2S.UpdatePlayerName.DeserializeFromBytes(updateData);
        if (!PlayerManager.Inst.IsValidPlayer(update.playerID, info.sender)) return;

        PlayerManager.Inst.UpdatePlayer(update);

        networkView.RPC("ClientSetPlayerName", RPCMode.Others, update.SerializeToBytes());

        ReadyToEnterCharacter(PlayerManager.Inst.GetSetting(update.playerID));
    }

    [RPC]
    void ClientSetPlayerName(byte[] updateData)
    {
        if (!Network.isClient) return;
        //ServerCheck

        C2S.UpdatePlayerName update = C2S.UpdatePlayerName.DeserializeFromBytes(updateData);

        PlayerManager.Inst.UpdatePlayer(update);
    }

    public void ServerSpecificUpdatePlayerName(C2S.UpdatePlayerName update)
    {
        PlayerManager.Inst.UpdatePlayer(update);
        Game.Inst.networkView.RPC("ClientSetPlayerName", RPCMode.Others, update.SerializeToBytes());

        PlayerSetting setting = PlayerManager.Inst.GetSetting(update.playerID);

        PlayerSettingError error = setting.IsSettingCompleted();
        if (error == PlayerSettingError.NONE)
        {
            EnterCharacter(setting);
            return;
        }

        S2C.PlayerNotReady notReady = new S2C.PlayerNotReady(error);

        switch (notReady.error)
        {
            case PlayerSettingError.NAME:
                OpenGameMenu();
                break;

            case PlayerSettingError.TEAM:
                teamSelector.Open();
                break;
        }
    }

    void ReadyToEnterCharacter(PlayerSetting setting)
    {
        if (!Network.isServer) return;

        PlayerSettingError error = setting.IsSettingCompleted();
        if (error == PlayerSettingError.NONE)
        {
            EnterCharacter(setting);
            return;
        }

        S2C.PlayerNotReady notReady = new S2C.PlayerNotReady(error);
        NetworkPlayer player = PlayerManager.Inst.GetPlayer(setting.playerID);
        networkView.RPC("PlayerNotReadyToEnter", player, notReady.SerializeToBytes());
    }

    [RPC]
    void PlayerNotReadyToEnter(byte[] notReadyData, NetworkMessageInfo info)
    {
        if (!Network.isClient) return;
        //ServerCheck

        S2C.PlayerNotReady notReady = S2C.PlayerNotReady.DeserializeFromBytes(notReadyData);

        switch(notReady.error)
        {
            case PlayerSettingError.NAME:
                OpenGameMenu();
                break;

            case PlayerSettingError.TEAM:
                teamSelector.Open();
                break;
        }
    
    }
    
    

    public void EnterCharacter(PlayerSetting setting)
    {
        if (!Network.isServer) return;

        Debug.Log(String.Format("Player Ready {0}", setting.playerID));

        GameObject newPlayer = Game.Inst.MakeNetworkPlayer();
        PlayerBehaviour character = newPlayer.GetComponent<PlayerBehaviour>();
        character.OnSetOwner(setting.playerID);
        newPlayer.networkView.RPC("SetOwner", RPCMode.OthersBuffered, setting.playerID);
    }

    [RPC]
    void PlayerListRequest(int requestorID, NetworkMessageInfo info)
    {
        if (!Network.isServer) return;
        if (!PlayerManager.Inst.IsValidPlayer(requestorID, info.sender)) return;
            
        S2C.PlayerList settings = new S2C.PlayerList(PlayerManager.Inst.GetSettings());

        byte[] settingsData = settings.SerializeToBytes();

        networkView.RPC("SetPlayerList", info.sender, settingsData);
    }

    [RPC]
    void SetPlayerList(byte[] playersData, NetworkMessageInfo info)
    {
        if (!Network.isClient)
            return;

        List<PlayerSetting> settings = S2C.PlayerList.DeserializeFromBytes(playersData).settings;

        foreach (PlayerSetting setting in settings)
        {
            PlayerManager.Inst.SetSetting(setting);
        }
    }

    void OnDisconnectedFromServer(NetworkDisconnection info)
    {
        if (Network.isServer)
        {
            OnServerDown();
        }

        if (Network.isClient)
        {
            OnServerDown();
        }
    }

    void OnServerDown()
    {
        PlayerManager.Inst.Clear();
        ProjectileManager.Inst.Clear();

        map = null;
    }


	public GameObject MakeNetworkPlayer()
	{
		return (GameObject)Network.Instantiate (playerPrefab, spawnPosition, Quaternion.identity, 0);
	}

    public void ClearGame()
    {
        PlayerManager.Inst.Clear();
        ProjectileManager.Inst.Clear();

		map = null;
		networkView.RPC ("ClientClearGame", RPCMode.Others);
    }

	[RPC]
	public void ClientClearGame()
	{
        PlayerManager.Inst.Clear();
        ProjectileManager.Inst.Clear();
		map = null;
	}

    void OnApplicationQuit()
    {
        isQuitting = true;
    }

    public bool IsQuitting()
    {
        return isQuitting;
    }

}